---
import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout title="Register | Music Blog">
  <section class="form-page">
    <h1>Create account</h1>
    <p class="meta">Register to publish posts and comment.</p>

    <form id="registerForm" class="form-card" novalidate>
      <label>
        Full name
        <input type="text" name="full_name" required />
      </label>

      <label>
        Username
        <input type="text" name="username" required />
      </label>

      <label>
        Favourite genre
        <input type="text" name="favourite_genre" />
      </label>

      <label>
        Email
        <input type="email" name="email" required />
      </label>

      <label>
        Password
        <input type="password" name="password" minlength="6" required />
      </label>

      <button class="btn" type="submit">Register</button>

      <p id="msg" class="meta" style="margin-top:12px;"></p>

      <p class="meta" style="margin-top:12px;">
        Already have an account? <a href="/login">Login</a>
      </p>
    </form>
  </section>

  <script>
    import { supabase } from "../lib/supabaseClient";

    document.addEventListener("DOMContentLoaded", () => {
      const formEl = document.querySelector("#registerForm");
      const msgEl = document.querySelector("#msg");

      const setMsg = (text) => {
        if (msgEl) msgEl.textContent = text;
      };

      if (!(formEl instanceof HTMLFormElement)) return;

      formEl.addEventListener("submit", async (e) => {
        e.preventDefault();
        setMsg("Creating account...");

        const formData = new FormData(formEl);

        const email = String(formData.get("email") || "");
        const password = String(formData.get("password") || "");
        const full_name = String(formData.get("full_name") || "");
        const username = String(formData.get("username") || "");
        const favourite_genre = String(formData.get("favourite_genre") || "");

        const { data, error } = await supabase.auth.signUp({
          email,
          password,
          options: {
            data: { full_name, username, favourite_genre },
            // manda o link de confirmação voltar pro seu site:
            emailRedirectTo: `${window.location.origin}/auth/callback`,
          },
        });

        if (error) {
          console.error(error);
          setMsg("Error: " + error.message);
          return;
        }

        // Se confirmação de email estiver ligada, session pode vir null:
        if (!data.session) {
          setMsg("Account created! Check your email to confirm, then login.");
          setTimeout(() => (window.location.href = "/login"), 1500);
          return;
        }

        setMsg("Registered! Redirecting...");
        window.location.href = "/account";
      });
    });
  </script>
</BaseLayout>
