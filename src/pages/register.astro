---
import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout title="Register | Music Blog">
  <section class="page auth-page">
    <div class="posts-hero-bg" aria-hidden="true">
      <img class="posts-hero-img" src="/images/hero5.jpg" alt="" loading="eager" />
      <div class="posts-hero-overlay"></div>
    </div>

    <header class="page-head">
      <div>
        <h1 class="page-title">Register</h1>
        <p class="page-subtitle">Create an account to publish and comment.</p>
      </div>

      <a class="btn btn-ghost" href="/login">Login</a>
    </header>

    <div class="posts-shell">
      <div id="alreadyLogged" class="glass-panel" style="display:none;">
        <p class="meta" style="margin:0 0 10px 0;">You are already logged in.</p>
        <div class="form-actions">
          <a class="btn" href="/account">Go to account</a>
          <button class="btn" id="logoutBtn" type="button">Logout</button>
        </div>
        <p id="logoutMsg" class="form-msg meta"></p>
      </div>

      <form id="registerForm" class="glass-panel" novalidate>
        <label>
          Full name
          <input type="text" name="full_name" required />
        </label>

        <label>
          Username
          <input type="text" name="username" required />
        </label>

        <label>
          Favourite genre
          <input type="text" name="favourite_genre" />
        </label>

        <label>
          Email
          <input type="email" name="email" required />
        </label>

        <label>
          Password
          <input type="password" name="password" minlength="6" required />
        </label>

        <div class="form-actions">
          <button class="btn" type="submit">Register</button>
          <p id="msg" class="form-msg meta"></p>
        </div>

        <p class="meta" style="margin-top:12px;">
          Already have an account? <a href="/login">Login</a>
        </p>
      </form>
    </div>
  </section>

  <script type="module">
    import { supabase } from "../lib/supabaseClient";


    function setMsg(el, text, status) {
      if (!el) return;
      el.textContent = text || "";
      if (status) el.setAttribute("data-status", status);
      else el.removeAttribute("data-status");
    }

    function initRegister() {
      const form = document.querySelector("#registerForm");
      const msg = document.querySelector("#msg");

      const alreadyLogged = document.querySelector("#alreadyLogged");
      const logoutBtn = document.querySelector("#logoutBtn");
      const logoutMsg = document.querySelector("#logoutMsg");

      if (!(form instanceof HTMLFormElement)) return;

      supabase.auth.getSession().then(({ data }) => {
        if (data.session) {
          form.style.display = "none";
          alreadyLogged.style.display = "block";
        } else {
          form.style.display = "block";
          alreadyLogged.style.display = "none";
        }
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        setMsg(msg, "Creating account...", "info");

        const fd = new FormData(form);
        const email = String(fd.get("email") || "").trim();
        const password = String(fd.get("password") || "");
        const full_name = String(fd.get("full_name") || "").trim();
        const username = String(fd.get("username") || "").trim();
        const favourite_genre = String(fd.get("favourite_genre") || "").trim();

        const { error } = await supabase.auth.signUp({
          email,
          password,
          options: {
            data: { full_name, username, favourite_genre },
          },
        });

        if (error) {
          console.error(error);
          setMsg(msg, "Error: " + error.message, "error");
          return;
        }

        setMsg(msg, "Registered! Check your email to confirm.", "success");
      });

      logoutBtn?.addEventListener("click", async () => {
        setMsg(logoutMsg, "Logging out...", "info");
        await supabase.auth.signOut();
        setMsg(logoutMsg, "Logged out.", "success");
        setTimeout(() => (window.location.href = "/register"), 250);
      });
    }

    document.addEventListener("astro:page-load", initRegister);
    if (document.readyState !== "loading") initRegister();
  </script>
</BaseLayout>
