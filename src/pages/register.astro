---
import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout title="Register | Music Blog">
  <section class="form-page">
    <h1>Create account</h1>
    <p class="meta">Register to publish posts and comment.</p>

    <form id="registerForm" class="form-card">
      <label>
        Full name
        <input type="text" name="full_name" required />
      </label>

      <label>
        Username
        <input type="text" name="username" required />
      </label>

      <label>
        Favourite genre
        <input type="text" name="favourite_genre" />
      </label>

      <label>
        Email
        <input type="email" name="email" required />
      </label>

      <label>
        Password
        <input type="password" name="password" minlength="6" required />
      </label>

      <button class="btn" type="submit">Register</button>

      <p id="msg" class="meta" style="margin-top:12px;"></p>

      <p class="meta" style="margin-top:12px;">
        Already have an account? <a href="/login">Login</a>
      </p>
    </form>
  </section>

  <!-- Inject Supabase env vars into the browser -->
  <script is:inline>
    window.PUBLIC_SUPABASE_URL = "{import.meta.env.PUBLIC_SUPABASE_URL}";
    window.PUBLIC_SUPABASE_ANON_KEY = "{import.meta.env.PUBLIC_SUPABASE_ANON_KEY}";
  </script>

  <script type="module">
   import { supabase } from "../lib/supabaseClient";


    console.log("✅ register script loaded");
    console.log("SUPABASE URL:", window.PUBLIC_SUPABASE_URL ? "OK" : "MISSING");
    console.log("SUPABASE KEY:", window.PUBLIC_SUPABASE_ANON_KEY ? "OK" : "MISSING");

    const form = document.querySelector("#registerForm");

    const msg = document.querySelector("#msg");

    function setMsg(text) {
      if (msg) msg.textContent = text;
    }

    form?.addEventListener("submit", async (e) => {
      e.preventDefault();
      setMsg("Creating account...");

      const formData = new FormData(form);
      const email = String(formData.get("email") || "");
      const password = String(formData.get("password") || "");

      const full_name = String(formData.get("full_name") || "");
      const username = String(formData.get("username") || "");
      const favourite_genre = String(formData.get("favourite_genre") || "");

      const { data, error } = await supabase.auth.signUp({
        email,
        password,
        options: {
          data: { full_name, username, favourite_genre },
        },
      });

      if (error) {
        console.error("❌ signUp error:", error);
        setMsg("Error: " + error.message);
        return;
      }

      console.log("✅ signUp ok:", data);
      setMsg("Registered! If email confirmation is enabled, check your inbox.");
      window.location.href = "/account";
    });
  </script>
</BaseLayout>

