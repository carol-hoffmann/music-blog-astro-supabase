---
export const prerender = false;

import BaseLayout from "../../layouts/BaseLayout.astro";
import { supabase } from "../../lib/supabaseClient";

const { id } = Astro.params;

// 1) Busca o post
const { data: post, error } = await supabase
  .from("posts")
  .select("id, title, content, created_at, user_id")
  .eq("id", id)
  .single();

if (error || !post) {
  throw new Error("Post not found");
}

// 2) Busca o perfil do autor (sem FK, seguro)
const { data: authorProfile } = await supabase
  .from("profiles")
  .select("username")
  .eq("id", post.user_id)
  .maybeSingle();

const authorUsername = authorProfile?.username
  ? `@${authorProfile.username}`
  : "@unknown";
---

<BaseLayout title="Post | Music Blog">
  <section class="page post-page">
    <div class="posts-hero-bg" aria-hidden="true">
      <img
        class="posts-hero-img"
        src="/images/hero5.jpg"
        alt=""
        loading="eager"
      />
      <div class="posts-hero-overlay"></div>
    </div>

    <div class="post-shell">
      <!-- IMPORTANTE: data-post-id e data-post-user-id -->
      <article
        class="post-panel"
        data-post-id={post.id}
        data-post-user-id={post.user_id}
      >
        <p class="meta post-back">
          <a href="/posts">← Back to posts</a>
        </p>

        <h1 class="post-title">{post.title}</h1>

        <p class="meta post-date">
          {new Date(post.created_at).toLocaleString()}
        </p>

        <!-- ✅ username do autor -->
        <p class="meta post-author">{authorUsername}</p>

        <div class="post-content">
          {post.content}
        </div>

        <div id="ownerActions" class="post-actions" style="display:none;">
          <a class="btn" id="editBtn" href="#">Edit</a>
          <button class="btn" id="deleteBtn" type="button">
            Delete
          </button>
        </div>

        <p id="msg" class="meta post-msg"></p>
      </article>

      <section class="post-panel">
        <div class="comments-head">
          <h2 class="comments-title">Comments</h2>
        </div>

        <div id="commentsWrap" class="comments-wrap">
          <p id="commentsMsg" class="meta">
            Loading comments...
          </p>
        </div>

        <div id="commentBox" class="comment-box" style="display:none;">
          <form id="commentForm" class="comment-form" novalidate>
            <label>
              Add a comment
              <textarea name="content" rows="3" required></textarea>
            </label>

            <div class="comment-actions">
              <button class="btn" type="submit">
                Post comment
              </button>
              <p id="commentFormMsg" class="meta"></p>
            </div>
          </form>
        </div>

        <p
          id="commentLoginMsg"
          class="meta"
          style="display:none;"
        >
          You must be logged in to comment.
          <a href="/login">Login</a>
        </p>
      </section>
    </div>
  </section>

  <script>
    import "../../scripts/postPage.ts";
  </script>
</BaseLayout>
