---
export const prerender = false;
import BaseLayout from "../../layouts/BaseLayout.astro";

const postPageUrl = new URL("../../scripts/postPage.ts", import.meta.url);
---

<BaseLayout title="Post | Music Blog">
  <section class="page post-page">
    <div class="posts-hero-bg" aria-hidden="true">
      <img class="posts-hero-img" src="/images/hero5.jpg" alt="" loading="eager" />
      <div class="posts-hero-overlay"></div>
    </div>

    <div class="post-shell">
      <article class="post-panel">
        <p class="meta post-back">
          <a href="/posts">← Back to posts</a>
        </p>

        <h1 id="title" class="post-title">Loading...</h1>
        <p id="date" class="meta post-date"></p>

        <div id="content" class="post-content"></div>

        <div id="ownerActions" class="post-actions" style="display:none;">
          <a class="btn" id="editBtn" href="#">Edit</a>
          <button class="btn" id="deleteBtn" type="button">Delete</button>
        </div>

        <p id="msg" class="meta post-msg"></p>
      </article>

      <section class="post-panel">
        <div class="comments-head">
          <h2 class="comments-title">Comments</h2>
        </div>

        <div id="commentsWrap" class="comments-wrap">
          <p id="commentsMsg" class="meta">Loading comments...</p>
        </div>

        <div id="commentBox" class="comment-box" style="display:none;">
          <form id="commentForm" class="comment-form" novalidate>
            <label>
              Add a comment
              <textarea name="content" rows="3" required></textarea>
            </label>

            <div class="comment-actions">
              <button class="btn" type="submit">Post comment</button>
              <p id="commentFormMsg" class="meta"></p>
            </div>
          </form>
        </div>

        <p id="commentLoginMsg" class="meta" style="display:none;">
          You must be logged in to comment. <a href="/login">Login</a>
        </p>
      </section>
    </div>
  </section>

    <script type="module">
    import { supabase } from "../../lib/supabaseClient";

    function qs(sel) {
      return document.querySelector(sel);
    }

    function setText(el, t) {
      if (el) el.textContent = t;
    }

    async function init() {
      const id = window.location.pathname.split("/").pop();

      const titleEl = qs("#title");
      const dateEl = qs("#date");
      const contentEl = qs("#content");
      const msgEl = qs("#msg");
      const ownerActions = qs("#ownerActions");
      const editBtn = qs("#editBtn");
      const deleteBtn = qs("#deleteBtn");

      const commentsWrap = qs("#commentsWrap");
      const commentsMsg = qs("#commentsMsg");
      const commentBox = qs("#commentBox");
      const commentLoginMsg = qs("#commentLoginMsg");
      const commentForm = qs("#commentForm");
      const commentFormMsg = qs("#commentFormMsg");

      if (!id) {
        setText(msgEl, "Missing post id.");
        return;
      }

      const { data: post, error } = await supabase
        .from("posts")
        .select("id, title, content, created_at, user_id")
        .eq("id", id)
        .single();

      if (error || !post) {
        console.error(error);
        setText(msgEl, "Post not found.");
        return;
      }

      setText(titleEl, post.title ?? "");
      setText(dateEl, new Date(post.created_at).toLocaleString());
      setText(contentEl, post.content ?? "");

      const { data: userData } = await supabase.auth.getUser();
      const user = userData?.user ?? null;

      if (user && user.id === post.user_id) {
        if (ownerActions) ownerActions.style.display = "flex";
        if (editBtn) editBtn.href = `/posts/edit/${post.id}`;
      }

      if (deleteBtn) {
        deleteBtn.addEventListener("click", async () => {
          if (!confirm("Delete this post? This cannot be undone.")) return;

          setText(msgEl, "Deleting...");

          const { error: delError } = await supabase.from("posts").delete().eq("id", post.id);

          if (delError) {
            console.error(delError);
            setText(msgEl, "Error: " + delError.message);
            return;
          }

          window.location.href = "/posts";
        });
      }

      if (user) {
        if (commentBox) commentBox.style.display = "block";
        if (commentLoginMsg) commentLoginMsg.style.display = "none";
      } else {
        if (commentBox) commentBox.style.display = "none";
        if (commentLoginMsg) commentLoginMsg.style.display = "block";
      }

      async function loadComments() {
        setText(commentsMsg, "Loading comments...");

        const { data: comments, error: cErr } = await supabase
          .from("comments")
          .select("id, content, created_at, user_id")
          .eq("post_id", post.id)
          .order("created_at", { ascending: true });

        if (cErr) {
          console.error(cErr);
          setText(commentsMsg, "Error loading comments: " + cErr.message);
          return;
        }

        if (!comments || comments.length === 0) {
          setText(commentsMsg, "No comments yet.");
          return;
        }

        if (commentsMsg) commentsMsg.remove();

        const html = comments
          .map((c) => {
            const date = new Date(c.created_at).toLocaleString();
            const author = c.user_id === user?.id ? "You" : String(c.user_id).slice(0, 8);

            return `
              <div class="comment-item">
                <div class="comment-meta">
                  <strong>${author}</strong> · ${date}
                </div>
                <div class="comment-text">${c.content}</div>
              </div>
            `;
          })
          .join("");

        if (commentsWrap) commentsWrap.innerHTML = html;
      }

      await loadComments();

      if (user && commentForm instanceof HTMLFormElement) {
        commentForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          setText(commentFormMsg, "Posting...");

          const fd = new FormData(commentForm);
          const content = String(fd.get("content") || "").trim();

          if (!content) {
            setText(commentFormMsg, "Please write a comment.");
            return;
          }

          const { error: insErr } = await supabase.from("comments").insert({
            post_id: post.id,
            user_id: user.id,
            content,
          });

          if (insErr) {
            console.error(insErr);
            setText(commentFormMsg, "Error: " + insErr.message);
            return;
          }

          commentForm.reset();
          setText(commentFormMsg, "Posted!");
          setTimeout(() => setText(commentFormMsg, ""), 900);

          await loadComments();
        });
      }
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>

</BaseLayout>
