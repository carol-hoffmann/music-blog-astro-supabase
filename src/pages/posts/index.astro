---
import BaseLayout from "../../layouts/BaseLayout.astro";
---

<BaseLayout title="Posts | Music Blog">
  <section class="page posts-page">
    <div class="posts-hero-bg" aria-hidden="true">
      <img
        class="posts-hero-img"
        src="/images/hero5.jpg"
        alt=""
        loading="eager"
      />
      <div class="posts-hero-overlay"></div>
    </div>

    <header class="page-head">
      <div>
        <h1 class="page-title">Posts</h1>
        <p class="page-subtitle">Latest posts in chronological order.</p>
      </div>
    </header>

    <div class="posts-shell">
      <div id="postsWrap" class="posts-grid">
        <p id="msg" class="meta">Loading posts...</p>
      </div>
    </div>
  </section>

<script>
  import { supabase } from "../../lib/supabaseClient";

  async function init() {
    const wrap = document.querySelector("#postsWrap");
    const msg = document.querySelector("#msg");
    if (!wrap || !msg) return;

    // 1) busca posts (inclui a coluna que referencia o autor)
    // Troque "user_id" abaixo se no seu banco for "author_id" ou outro nome.
    const { data: posts, error: postsError } = await supabase
      .from("posts")
      .select("id, title, created_at, content, user_id")
      .order("created_at", { ascending: false });

    if (postsError) {
      console.error(postsError);
      msg.textContent = "Error loading posts: " + postsError.message;
      return;
    }

    if (!posts || posts.length === 0) {
      msg.textContent = "No posts yet.";
      return;
    }

    // 2) pega ids únicos dos autores
    const userIds = Array.from(
      new Set(posts.map((p) => p.user_id).filter(Boolean))
    );

    // 3) busca perfis desses autores (sem join)
    // Se sua tabela não se chama "profiles" ou o campo não é "username", me diga que eu ajusto.
    let profilesById = {};
    if (userIds.length > 0) {
      const { data: profiles, error: profError } = await supabase
        .from("profiles")
        .select("id, username")
        .in("id", userIds);

      if (profError) {
        console.warn("Profiles load failed:", profError.message);
      } else {
        profilesById = Object.fromEntries(
          (profiles || []).map((pr) => [pr.id, pr])
        );
      }
    }

    msg.remove();

    const formatDate = (iso) => new Date(iso).toLocaleString();
    const excerpt = (text, n = 130) => {
      const t = String(text || "").trim();
      if (!t) return "No description yet.";
      return t.length > n ? t.slice(0, n).trim() + "…" : t;
    };

    const authorLabel = (p) => {
      const pr = profilesById[p.user_id];
      return pr?.username ? `@${pr.username}` : "@unknown";
    };

    wrap.innerHTML = posts
      .map(
        (p) => `
        <article class="post-card">
          <a class="post-card-link" href="/posts/${p.id}">
            <div class="post-card-top">
              <h3 class="post-card-title">${p.title}</h3>
              <p class="post-card-date">${formatDate(p.created_at)}</p>
              <p class="post-card-author">${authorLabel(p)}</p>
            </div>
            <p class="post-card-excerpt">${excerpt(p.content)}</p>
            <div class="post-card-cta">
              <span>Read post</span>
              <span class="post-card-arrow">→</span>
            </div>
          </a>
        </article>
      `
      )
      .join("");
  }

  document.addEventListener("astro:page-load", init);
  if (document.readyState !== "loading") init();
  else document.addEventListener("DOMContentLoaded", init);
</script>


</BaseLayout>