---
import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout title="Set New Password | Music Blog">
  <section class="page auth-page">
    <div class="posts-hero-bg" aria-hidden="true">
      <img class="posts-hero-img" src="/images/hero5.jpg" alt="" loading="eager" />
      <div class="posts-hero-overlay"></div>
    </div>

    <header class="page-head">
      <div>
        <h1 class="page-title">Set new password</h1>
        <p class="page-subtitle">Choose a new password for your account.</p>
      </div>

      <a class="btn btn-ghost" href="/login">Login</a>
    </header>

    <div class="posts-shell">
      <form id="resetForm" class="glass-panel" novalidate style="display:none;">
        <label>
          New password
          <input type="password" name="password" minlength="6" required />
        </label>

        <div class="form-actions">
          <button class="btn" type="submit">Update password</button>
          <p id="msg" class="form-msg meta"></p>
        </div>
      </form>

      <p id="status" class="meta is-loading">Checking reset link...</p>
    </div>
  </section>

  <script>
    import { supabase } from "../lib/supabaseClient";

    document.addEventListener("DOMContentLoaded", () => {
      const form = document.querySelector("#resetForm");
      const msg = document.querySelector("#msg");
      const status = document.querySelector("#status");

      const setMsg = (t) => msg && (msg.textContent = t);
      const setStatus = (t) => status && (status.textContent = t);

      (async () => {

        const { data } = await supabase.auth.getSession();

        if (!data.session) {
          setStatus("Invalid or expired link. Please request a new reset link.");
          return;
        }

        // ok, pode mostrar form
        if (status) status.style.display = "none";
        if (form) form.style.display = "block";

        if (!(form instanceof HTMLFormElement)) return;

        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          setMsg("Updating...");

          const fd = new FormData(form);
          const password = String(fd.get("password") || "");

          const { error } = await supabase.auth.updateUser({ password });

          if (error) {
            console.error(error);
            setMsg("Error: " + error.message);
            return;
          }

          setMsg("Password updated! Redirecting...");
          setTimeout(() => (window.location.href = "/account"), 700);
        });
      })();
    });
  </script>
</BaseLayout>
