---
import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout title="Login | Music Blog">
  <section class="page auth-page">
    <div class="posts-hero-bg" aria-hidden="true">
      <img class="posts-hero-img" src="/images/hero5.jpg" alt="" loading="eager" />
      <div class="posts-hero-overlay"></div>
    </div>

    <header class="page-head">
      <div>
        <h1 class="page-title">Login</h1>
        <p class="page-subtitle">Access your account to manage posts.</p>
      </div>

      <a class="btn btn-ghost" href="/register">Register</a>
    </header>

    <div class="posts-shell">
      <form id="loginForm" class="glass-panel" novalidate>
        <label>
          Email
          <input type="email" name="email" required />
        </label>

        <label>
          Password
          <input type="password" name="password" required />
        </label>

        <div class="form-actions">
          <button class="btn" type="submit">Login</button>
          <p id="msg" class="form-msg meta"></p>
        </div>

        <p class="meta" style="margin-top:12px;">
          Don't have an account? <a href="/register">Register</a>
        </p>
      </form>
    </div>
  </section>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const urlMeta = document.querySelector('meta[name="supabase-url"]');
    const keyMeta = document.querySelector('meta[name="supabase-anon-key"]');

    const supabaseUrl = urlMeta?.getAttribute("content") || "";
    const supabaseAnonKey = keyMeta?.getAttribute("content") || "";

    const supabase = createClient(supabaseUrl, supabaseAnonKey);

    const form = document.querySelector("#loginForm");
    const msg = document.querySelector("#msg");
    const setMsg = (t) => msg && (msg.textContent = t);

    if (form instanceof HTMLFormElement) {
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const formData = new FormData(form);
        const email = String(formData.get("email") || "").trim();
        const password = String(formData.get("password") || "");

        if (!email || !password) {
          setMsg("Please fill email and password.");
          return;
        }

        setMsg("Logging in...");

        const { error } = await supabase.auth.signInWithPassword({ email, password });

        if (error) {
          console.error(error);
          setMsg("Error: " + error.message);
          return;
        }

        setMsg("Success! Redirecting...");
        setTimeout(() => (window.location.href = "/account"), 500);
      });
    }
  </script>
</BaseLayout>
