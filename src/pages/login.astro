---
import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout title="Login | Music Blog">
  <section class="form-page">
    <h1>Login</h1>
    <p class="meta">Access your account to create and manage posts.</p>

    <form id="loginForm" class="form-card" novalidate>
      <label>
        Email
        <input type="email" name="email" required />
      </label>

      <label>
        Password
        <input type="password" name="password" required />
      </label>

      <button class="btn" type="submit">Login</button>

      <p id="msg" class="meta" style="margin-top:12px;"></p>

      <p class="meta" style="margin-top:12px;">
        Don't have an account? <a href="/register">Register</a>
      </p>
    </form>
  </section>

  <script>
    import { supabase } from "../lib/supabaseClient";

    document.addEventListener("DOMContentLoaded", () => {
      console.log("✅ login script loaded");

      const formEl = document.querySelector("#loginForm");
      const msgEl = document.querySelector("#msg");

      const setMsg = (t) => msgEl && (msgEl.textContent = t);

      (async () => {
        // ✅ If already logged in, go to account
        const { data } = await supabase.auth.getUser();
        if (data?.user) {
          window.location.href = "/account";
          return;
        }

        if (!(formEl instanceof HTMLFormElement)) return;

        formEl.addEventListener("submit", async (e) => {
          e.preventDefault();
          setMsg("Logging in...");

          const formData = new FormData(formEl);
          const email = String(formData.get("email") || "");
          const password = String(formData.get("password") || "");

          const { data, error } = await supabase.auth.signInWithPassword({
            email,
            password,
          });

          if (error) {
            setMsg("Error: " + error.message);
            return;
          }

          if (!data.session) {
            setMsg("Login succeeded but no session found.");
            return;
          }

          window.location.href = "/account";
        });
      })();
    });
  </script>
</BaseLayout>
