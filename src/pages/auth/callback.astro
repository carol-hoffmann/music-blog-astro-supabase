---
import BaseLayout from "../../layouts/BaseLayout.astro";
---

<BaseLayout title="Auth Callback | Music Blog">
  <section class="form-page">
    <h1>Finishing confirmationâ€¦</h1>
    <p class="meta" id="msg">Please wait.</p>
  </section>

  <script>
    import { supabase } from "../../lib/supabaseClient";

    const msg = document.querySelector("#msg");
    const setMsg = (t) => msg && (msg.textContent = t);

    (async () => {
      try {
        const exchange = supabase.auth.exchangeCodeForSession?.bind(
          supabase.auth
        );

        if (window.location.search.includes("code=") && exchange) {
          await exchange(window.location.href);
        }

        const { data } = await supabase.auth.getSession();

        if (data?.session) {
          window.location.href = "/account";
          return;
        }

        setMsg("Email confirmed. Please login.");
        setTimeout(() => (window.location.href = "/login"), 1200);
      } catch {
        setMsg("Confirmation finished. Please login.");
        setTimeout(() => (window.location.href = "/login"), 1200);
      }
    })();
  </script>
</BaseLayout>
