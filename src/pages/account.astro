---
import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout title="Account | Music Blog">
  <section class="form-page">
    <h1>Account</h1>
    <p class="meta">Manage your profile details.</p>

    <div class="form-card">
      <p id="status" class="meta">Checking session...</p>
      <div id="info"></div>

      <div style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap;">
        <a class="btn" href="/posts/new">Create new post</a>
        <button class="btn" id="logoutBtn" type="button">Logout</button>
      </div>
    </div>

    <script type="module">
      import { supabase } from "@/lib/supabaseClient";


      const status = document.querySelector("#status");
      const info = document.querySelector("#info");
      const logoutBtn = document.querySelector("#logoutBtn");

      const { data } = await supabase.auth.getSession();
      const session = data.session;

      if (!session) {
        status.textContent = "You are not logged in.";
        info.innerHTML = `
          <p class="meta">
            <a class="btn" href="/login">Go to login</a>
          </p>
        `;
      } else {
        status.textContent = "Logged in.";
        const user = session.user;

        info.innerHTML = `
          <p><strong>Email:</strong> ${user.email}</p>
          <p><strong>Name:</strong> ${user.user_metadata?.full_name ?? "-"}</p>
          <p><strong>Username:</strong> ${user.user_metadata?.username ?? "-"}</p>
          <p><strong>Favourite genre:</strong> ${user.user_metadata?.favourite_genre ?? "-"}</p>
        `;
      }

      logoutBtn?.addEventListener("click", async () => {
        await supabase.auth.signOut();
        window.location.href = "/";
      });
    </script>
  </section>
</BaseLayout>
