---
import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout title="Account | Music Blog">
  <section class="form-page">
    <h1>Account</h1>
    <p class="meta">Manage your profile details.</p>

    <div class="form-card">
      <p id="status" class="meta">Checking session...</p>
      <div id="info"></div>

      <div style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap;">
        <a class="btn" href="/posts/new">Create new post</a>
        <button class="btn" id="logoutBtn" type="button">Logout</button>
      </div>
    </div>
  </section>

  <script>
    import { supabase } from "../lib/supabaseClient";

    document.addEventListener("DOMContentLoaded", () => {
      console.log("✅ account script loaded");

      const statusEl = document.querySelector("#status");
      const infoEl = document.querySelector("#info");
      const logoutBtn = document.querySelector("#logoutBtn");

      const setStatus = (t) => statusEl && (statusEl.textContent = t);
      const setInfo = (h) => infoEl && (infoEl.innerHTML = h);

      async function renderAccount() {
        try {
          setStatus("Checking session...");

          // 1) Checa sessão local
          const { data: sessionData, error: sessionError } = await supabase.auth.getSession();
          console.log("getSession()", sessionData, sessionError);

          if (sessionError) {
            console.error("getSession error:", sessionError);
            setStatus("Error checking session.");
            setInfo(`<p class="meta">Error: ${sessionError.message}</p><p><a class="btn" href="/login">Go to login</a></p>`);
            return;
          }

          // 2) Checa usuário (mais confiável em alguns casos)
          const { data: userData, error: userError } = await supabase.auth.getUser();
          console.log("getUser()", userData, userError);

          if (userError) {
            // Se não tem user, você não está logada (ou token inválido)
            setStatus("You are not logged in.");
            setInfo(`<p><a class="btn" href="/login">Go to login</a></p>`);
            return;
          }

          const user = userData.user;
          if (!user) {
            setStatus("You are not logged in.");
            setInfo(`<p><a class="btn" href="/login">Go to login</a></p>`);
            return;
          }

          setStatus("Logged in.");
          setInfo(`
            <p><strong>Email:</strong> ${user.email ?? "-"}</p>
            <p><strong>Name:</strong> ${user.user_metadata?.full_name ?? "-"}</p>
            <p><strong>Username:</strong> ${user.user_metadata?.username ?? "-"}</p>
            <p><strong>Favourite genre:</strong> ${user.user_metadata?.favourite_genre ?? "-"}</p>
          `);
        } catch (err) {
          console.error("Account render crash:", err);
          setStatus("Account error.");
          setInfo(`<p class="meta">Open the console to see details.</p>`);
        }
      }

      renderAccount();

      // Atualiza se o estado de auth mudar
      supabase.auth.onAuthStateChange(() => {
        renderAccount();
      });

      logoutBtn?.addEventListener("click", async () => {
        await supabase.auth.signOut();
        window.location.href = "/";
      });
    });
  </script>
</BaseLayout>
