---
import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout title="Account | Music Blog">
  <section class="form-page">
    <h1>Account</h1>
    <p class="meta">Manage your profile details.</p>

    <div class="form-card">
      <p id="status" class="meta">Checking session...</p>
      <div id="info"></div>

      <div style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap;">
        <a class="btn" href="/posts/new">Create new post</a>
        <button class="btn" id="logoutBtn" type="button">Logout</button>
        <button class="btn" id="clearBtn" type="button">Clear local session</button>
      </div>
    </div>
  </section>

  <script>
    import { supabase } from "../lib/supabaseClient";

    document.addEventListener("DOMContentLoaded", () => {
      const statusEl = document.querySelector("#status");
      const infoEl = document.querySelector("#info");
      const logoutBtn = document.querySelector("#logoutBtn");
      const clearBtn = document.querySelector("#clearBtn");

      const setStatus = (t) => statusEl && (statusEl.textContent = t);
      const setInfo = (h) => infoEl && (infoEl.innerHTML = h);

      async function renderAccount() {
        try {
          setStatus("Checking session...");

          // Usa getUser (mais confiável em produção)
          const { data, error } = await supabase.auth.getUser();

          if (error || !data?.user) {
            setStatus("You are not logged in.");
            setInfo(`<p><a class="btn" href="/login">Go to login</a></p>`);
            return;
          }

          const user = data.user;

          setStatus("Logged in.");
          setInfo(`
            <p><strong>Email:</strong> ${user.email ?? "-"}</p>
            <p><strong>Name:</strong> ${user.user_metadata?.full_name ?? "-"}</p>
            <p><strong>Username:</strong> ${user.user_metadata?.username ?? "-"}</p>
            <p><strong>Favourite genre:</strong> ${user.user_metadata?.favourite_genre ?? "-"}</p>
          `);
        } catch (err) {
          console.error("Account error:", err);
          setStatus("Account error.");
          setInfo(`<p class="meta">Open DevTools → Console for details.</p>`);
        }
      }

      renderAccount();

      supabase.auth.onAuthStateChange(() => {
        renderAccount();
      });

      logoutBtn?.addEventListener("click", async () => {
        try {
          await supabase.auth.signOut();
        } catch {}
        window.location.href = "/";
      });

      clearBtn?.addEventListener("click", () => {
        // Remove qualquer token do Supabase salvo no browser
        for (const key of Object.keys(localStorage)) {
          if (key.startsWith("sb-") && key.includes("-auth-token")) {
            localStorage.removeItem(key);
          }
        }
        window.location.href = "/login";
      });
    });
  </script>
</BaseLayout>
