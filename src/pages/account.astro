---
import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout title="Account | Music Blog">
  <section class="page account-page">
    <div class="posts-hero-bg" aria-hidden="true">
      <img class="posts-hero-img" src="/images/hero5.jpg" alt="" loading="eager" />
      <div class="posts-hero-overlay"></div>
    </div>

    <header class="page-head">
      <div>
        <h1 class="page-title">Account</h1>
        <p class="page-subtitle">View and update your profile details.</p>
      </div>

      <a class="btn btn-ghost" href="/posts">Posts</a>
    </header>

    <div class="posts-shell">
      <!-- Profile -->
      <div class="glass-panel">
        <p id="status" class="meta is-loading">Checking session...</p>

        <form id="profileForm" style="display:none; margin-top:14px;" novalidate>
          <p class="meta" style="margin-bottom:10px;">
            Logged in as <strong id="email"></strong>
          </p>

          <label>
            Full name
            <input type="text" id="full_name" required disabled />
          </label>

          <label>
            Username
            <input type="text" id="username" required disabled />
          </label>

          <label>
            Favourite genre
            <input type="text" id="favourite_genre" required disabled />
          </label>

          <div class="form-actions" style="margin-top:14px;">
            <button class="btn" id="editBtn" type="button">Edit profile</button>
            <button class="btn" id="saveBtn" type="submit" disabled>Save changes</button>
            <button class="btn btn-ghost" id="logoutBtn" type="button">Logout</button>
            <p id="msg" class="form-msg meta"></p>
          </div>
        </form>

        <p id="loginHint" class="meta hint" style="display:none; margin-top:12px;">
          You are not logged in. <a href="/login">Login</a>
        </p>
      </div>

      <!-- My posts -->
      <section class="glass-panel" style="margin-top:16px;">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
          <h2 class="page-subtitle" style="margin:0;">My posts</h2>
          <a class="btn btn-ghost" href="/posts/new">New post</a>
        </div>

        <div id="myPostsWrap" class="posts-grid" style="margin-top:12px;">
          <p id="myPostsMsg" class="meta">Loading your posts...</p>
        </div>
      </section>
    </div>
  </section>

  <script>
    import { supabase } from "../lib/supabaseClient";

    async function init() {
      const qs = (s) => document.querySelector(s);

      const status = qs("#status");
      const loginHint = qs("#loginHint");
      const form = qs("#profileForm");
      const msg = qs("#msg");

      const emailEl = qs("#email");
      const fullNameEl = qs("#full_name");
      const usernameEl = qs("#username");
      const favEl = qs("#favourite_genre");

      const editBtn = qs("#editBtn");
      const saveBtn = qs("#saveBtn");
      const logoutBtn = qs("#logoutBtn");

      const myPostsWrap = qs("#myPostsWrap");
      const myPostsMsg = qs("#myPostsMsg");

      const setStatus = (t) => status && (status.textContent = t || "");
      const setMsg = (t) => msg && (msg.textContent = t || "");
      const setMyPostsMsg = (t) => myPostsMsg && (myPostsMsg.textContent = t || "");

      let userId = null;
      let editMode = false;

      function setEditing(on) {
        editMode = on;
        fullNameEl.disabled = !on;
        usernameEl.disabled = !on;
        favEl.disabled = !on;
        saveBtn.disabled = !on;
        editBtn.textContent = on ? "Cancel" : "Edit profile";
        setMsg("");
      }

      // Session
      const { data } = await supabase.auth.getSession();
      const session = data?.session;

      status?.classList.remove("is-loading");

      if (!session) {
        setStatus("");
        loginHint.style.display = "block";
        setMyPostsMsg("Login to see your posts.");
        return;
      }

      const user = session.user;
      userId = user.id;
      emailEl.textContent = user.email || "";

      // Profile
      setStatus("Loading profile...");
      const { data: profile } = await supabase
        .from("profiles")
        .select("full_name, username, favourite_genre")
        .eq("id", userId)
        .maybeSingle();

      fullNameEl.value = profile?.full_name ?? "";
      usernameEl.value = profile?.username ?? "";
      favEl.value = profile?.favourite_genre ?? "";

      setStatus("");
      form.style.display = "block";
      setEditing(false);

      editBtn.addEventListener("click", () => setEditing(!editMode));

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!editMode) return;

        setMsg("Saving...");
        const { error } = await supabase.from("profiles").upsert(
          {
            id: userId,
            full_name: fullNameEl.value.trim(),
            username: usernameEl.value.trim(),
            favourite_genre: favEl.value.trim(),
          },
          { onConflict: "id" }
        );

        if (error) {
          setMsg("Error: " + error.message);
          return;
        }

        setMsg("Saved!");
        setEditing(false);
        setTimeout(() => setMsg(""), 800);
      });

      logoutBtn.addEventListener("click", async () => {
        await supabase.auth.signOut();
        localStorage.clear();
        sessionStorage.clear();
        window.location.href = "/login";
      });

      // My posts
      const { data: posts, error } = await supabase
        .from("posts")
        .select("id, title, created_at, content")
        .eq("user_id", userId)
        .order("created_at", { ascending: false });

      if (error) {
        setMyPostsMsg("Error loading posts.");
        return;
      }

      if (!posts || posts.length === 0) {
        setMyPostsMsg("You haven't published any posts yet.");
        return;
      }

      myPostsMsg.remove();

      const formatDate = (iso) => new Date(iso).toLocaleString();
      const excerpt = (t, n = 120) =>
        t && t.length > n ? t.slice(0, n).trim() + "â€¦" : t || "No description yet.";

      myPostsWrap.innerHTML = posts
        .map(
          (p) => `
          <article class="post-card">
            <div class="post-card-top">
              <h3 class="post-card-title">${p.title}</h3>
              <p class="post-card-date">${formatDate(p.created_at)}</p>
            </div>

            <p class="post-card-excerpt">${excerpt(p.content)}</p>

            <div class="post-card-cta" style="display:flex; gap:8px;">
              <a class="btn btn-ghost" href="/posts/${p.id}">View</a>
              <a class="btn" href="/posts/edit/${p.id}">Edit</a>
            </div>
          </article>
        `
        )
        .join("");
    }

    document.addEventListener("astro:page-load", init);
    if (document.readyState !== "loading") init();
    else document.addEventListener("DOMContentLoaded", init);
  </script>
</BaseLayout>
