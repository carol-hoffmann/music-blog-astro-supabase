---
import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout title="Forgot Password | Music Blog">
  <section class="page auth-page">
    <div class="posts-hero-bg" aria-hidden="true">
      <img class="posts-hero-img" src="/images/hero5.jpg" alt="" loading="eager" />
      <div class="posts-hero-overlay"></div>
    </div>

    <header class="page-head">
      <div>
        <h1 class="page-title">Reset password</h1>
        <p class="page-subtitle">Enter your email to receive a reset link.</p>
      </div>

      <a class="btn btn-ghost" href="/login">Back to login</a>
    </header>

    <div class="posts-shell">
      <form id="forgotForm" class="glass-panel" novalidate>
        <label>
          Email
          <input type="email" name="email" autocomplete="email" required />
        </label>

        <div class="form-actions">
          <button class="btn" type="submit">Send reset link</button>
          <p id="msg" class="form-msg meta"></p>
        </div>
      </form>
    </div>
  </section>

  <script>
    import { supabase } from "../lib/supabaseClient";

    document.addEventListener("DOMContentLoaded", () => {
      const form = document.querySelector("#forgotForm");
      const msg = document.querySelector("#msg");
      const setMsg = (t) => msg && (msg.textContent = t);

      const redirectTo =
        window.location.origin + "/reset-password";

      if (!(form instanceof HTMLFormElement)) return;

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        setMsg("Sending...");

        const fd = new FormData(form);
        const email = String(fd.get("email") || "").trim();

        const { error } = await supabase.auth.resetPasswordForEmail(email, {
          redirectTo,
        });

        if (error) {
          console.error(error);
          setMsg("Error: " + error.message);
          return;
        }

        setMsg("Done! Check your email for the reset link.");
        form.reset();
      });
    });
  </script>
</BaseLayout>
